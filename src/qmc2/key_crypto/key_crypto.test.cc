#include "parakeet-crypto/qmc2/key_crypto.h"

#include <array>
#include <gmock/gmock.h>
#include <gtest/gtest.h>

#include <cstdint>
#include <filesystem>
#include <fstream>
#include <memory>
#include <numeric>
#include <vector>

using ::testing::ElementsAreArray;

using namespace parakeet_crypto;

// NOLINTBEGIN(*-magic-numbers,cppcoreguidelines-avoid-non-const-global-variables,cppcoreguidelines-owning-memory)

#pragma region fixture
constexpr const std::array<uint8_t, 364> kEncryptedKeyV1 = {
    0x4F, 0x57, 0x4A, 0x33, 0x57, 0x46, 0x5A, 0x47, 0x53, 0x48, 0x58, 0x74, 0x4E, 0x43, 0x30, 0x73, 0x52, 0x41, 0x2F,
    0x35, 0x47, 0x42, 0x59, 0x65, 0x6A, 0x43, 0x38, 0x6A, 0x61, 0x34, 0x66, 0x49, 0x4B, 0x37, 0x44, 0x49, 0x30, 0x32,
    0x4D, 0x4C, 0x30, 0x34, 0x4E, 0x4A, 0x42, 0x51, 0x56, 0x67, 0x54, 0x54, 0x79, 0x6D, 0x7A, 0x52, 0x78, 0x4D, 0x2F,
    0x2F, 0x56, 0x62, 0x46, 0x43, 0x44, 0x71, 0x6A, 0x76, 0x32, 0x32, 0x69, 0x47, 0x59, 0x69, 0x76, 0x48, 0x4D, 0x64,
    0x30, 0x59, 0x2B, 0x57, 0x51, 0x41, 0x44, 0x51, 0x2B, 0x57, 0x37, 0x4B, 0x74, 0x52, 0x72, 0x6E, 0x37, 0x30, 0x2B,
    0x37, 0x57, 0x39, 0x55, 0x4A, 0x61, 0x36, 0x6D, 0x49, 0x52, 0x36, 0x59, 0x4F, 0x78, 0x32, 0x66, 0x30, 0x45, 0x56,
    0x6A, 0x68, 0x63, 0x36, 0x31, 0x2B, 0x4D, 0x66, 0x72, 0x73, 0x66, 0x2B, 0x61, 0x64, 0x67, 0x71, 0x73, 0x36, 0x33,
    0x31, 0x55, 0x42, 0x78, 0x70, 0x50, 0x72, 0x59, 0x67, 0x32, 0x53, 0x74, 0x50, 0x2B, 0x31, 0x4F, 0x79, 0x54, 0x41,
    0x67, 0x74, 0x55, 0x74, 0x53, 0x50, 0x6B, 0x66, 0x32, 0x56, 0x33, 0x43, 0x53, 0x34, 0x2B, 0x53, 0x45, 0x36, 0x30,
    0x64, 0x62, 0x71, 0x64, 0x42, 0x75, 0x68, 0x67, 0x6B, 0x55, 0x53, 0x42, 0x6A, 0x71, 0x42, 0x6B, 0x43, 0x31, 0x67,
    0x6E, 0x69, 0x6C, 0x6A, 0x63, 0x41, 0x32, 0x6D, 0x43, 0x36, 0x6B, 0x72, 0x7A, 0x57, 0x67, 0x67, 0x31, 0x44, 0x42,
    0x74, 0x71, 0x66, 0x41, 0x31, 0x5A, 0x53, 0x41, 0x52, 0x37, 0x33, 0x4E, 0x42, 0x2F, 0x67, 0x33, 0x44, 0x70, 0x54,
    0x33, 0x75, 0x35, 0x49, 0x44, 0x52, 0x35, 0x69, 0x37, 0x5A, 0x71, 0x37, 0x52, 0x63, 0x39, 0x55, 0x4E, 0x69, 0x63,
    0x79, 0x64, 0x56, 0x6A, 0x46, 0x64, 0x36, 0x39, 0x36, 0x45, 0x4C, 0x5A, 0x4D, 0x61, 0x4D, 0x6A, 0x75, 0x4E, 0x6F,
    0x31, 0x4D, 0x58, 0x72, 0x73, 0x72, 0x52, 0x43, 0x6C, 0x49, 0x75, 0x37, 0x31, 0x4B, 0x70, 0x2B, 0x66, 0x57, 0x6D,
    0x53, 0x37, 0x6E, 0x5A, 0x4F, 0x48, 0x72, 0x61, 0x6B, 0x51, 0x4B, 0x30, 0x30, 0x55, 0x64, 0x61, 0x78, 0x6E, 0x6C,
    0x62, 0x47, 0x62, 0x57, 0x59, 0x52, 0x4B, 0x6D, 0x64, 0x53, 0x30, 0x62, 0x45, 0x71, 0x2B, 0x51, 0x6E, 0x6C, 0x66,
    0x63, 0x50, 0x33, 0x79, 0x41, 0x4D, 0x69, 0x57, 0x54, 0x51, 0x6A, 0x79, 0x52, 0x59, 0x52, 0x55, 0x62, 0x68, 0x6C,
    0x42, 0x50, 0x38, 0x50, 0x4F, 0x79, 0x4C, 0x51, 0x51, 0x55, 0x51, 0x61, 0x54, 0x46, 0x4E, 0x42, 0x77, 0x37, 0x48,
    0x50, 0x55, 0x3D};

constexpr const std::array<uint8_t, 256> kExpectedKey = {
    '9', 'b', 'w', 'X', 'V', 'F', 'H', 'u', 'o', 'I', '4', '1', 'E', 'S', 'I', '9', 'Z', '8', 'W', 'h', 'u', 'Q',
    'u', 't', 'U', 'M', '8', '5', 'X', 'n', 'P', 'v', '1', 'r', '8', '1', 'p', 'y', '4', 't', '4', '2', 't', '0',
    '1', '4', '8', 'E', 'u', '5', 'x', 'Q', '8', 'a', 'J', '5', 'D', '9', '9', 'r', 'S', 'O', 'n', 'l', '3', 'D',
    'N', '5', '3', 'H', 'Y', '1', '2', 'c', '1', 'O', 'k', '4', 'W', 'H', 'O', '6', 'h', '0', 'H', '8', 'S', 'J',
    'n', 'd', 'E', '3', '0', 'M', 'z', 'K', '3', 'o', 'Q', 'k', 'y', '5', 'R', 'm', 'B', '6', 'n', 'V', '9', '3',
    '4', 'Q', 'G', 'd', 'L', 'v', '7', '3', 'Q', '6', 'l', '8', '3', '6', 'E', '8', 'n', '1', '5', 'R', '5', '6',
    'N', 'M', 'r', 'X', '0', 'D', 'P', 'y', 'h', 'h', 'r', '1', 'K', 'd', 's', 'L', 'C', 'N', 'V', 'Y', 'H', '9',
    'q', 'U', '0', 'T', '6', '7', 'q', 'A', '5', 'U', '5', 'M', 'V', '6', '7', 'E', '7', 'F', '4', 'S', '1', '2',
    'q', 'R', 'c', 'y', '3', '1', 'Z', 'X', 'J', 'X', '8', '3', '1', 'x', 'a', 'b', 'y', 'a', '5', 's', '2', 'v',
    '5', 'g', '0', 'c', 'K', 'k', '2', 'o', 'T', 'z', '7', '4', 'F', '5', '6', 'm', '5', 'P', '8', 'j', 'Y', 'E',
    '1', 'k', 'M', '2', 'Q', '0', 'Z', 's', '4', '4', 'Z', 'G', '6', 'I', 'l', 'K', 'j', 'R', 'I', '0', 'w', 'v',
    '1', 'C', '0', 'D', 't', 'T', '1', 'h', 'u', 'g', '8', '8', '8', 'z',
};
#pragma endregion

TEST(KeyCrypto, DecryptBasicKeyDecryption)
{
    std::array<uint8_t, 16> key_1{};
    std::array<uint8_t, 16> key_2{};
    std::iota(key_1.begin(), key_1.end(), 0x66);
    std::iota(key_2.begin(), key_2.end(), 0x99);

    auto key_crypto = qmc2::CreateKeyCrypto(key_1.data(), key_2.data());
    auto key = key_crypto->Decrypt(kEncryptedKeyV1.data(), kEncryptedKeyV1.size());
    ASSERT_THAT(key, ElementsAreArray(kExpectedKey));
}

TEST(KeyCrypto, DecryptEncV2Key)
{
    std::array<uint8_t, 16> key_1{};
    std::array<uint8_t, 16> key_2{};
    std::iota(key_1.begin(), key_1.end(), 0x66);
    std::iota(key_2.begin(), key_2.end(), 0x99);

    auto key_crypto = qmc2::CreateKeyCrypto(key_1.data(), key_2.data());
    auto key_enc_v2 = key_crypto->Encrypt(kExpectedKey.data(), kExpectedKey.size(), qmc2::KeyVersion::VERSION_2);
    auto key = key_crypto->Decrypt(key_enc_v2.data(), key_enc_v2.size());
    ASSERT_THAT(key, ElementsAreArray(kExpectedKey));
}

// NOLINTEND(*-magic-numbers,cppcoreguidelines-avoid-non-const-global-variables,cppcoreguidelines-owning-memory)
